<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Embed Splits</title>
  <style>
    :root{
      --gap:12px;
      --bg:#434343;
      --card:#1b1b1b;
      --muted:#cccccc99;
    }
    html,body{height:100%;}
    body{
      margin:0; background:var(--bg); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column;
    }
    header{display:flex; align-items:center; gap:12px; padding:12px; background:linear-gradient(180deg,#0f0f0f, #0b0b0b); box-shadow:0 2px 8px #0003}
    h1{font-size:16px; margin:0}
    .controls{margin-left:auto; display:flex; gap:8px; align-items:center}
    button, .toggle{background:transparent; border:1px solid #333; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer}
    button.primary{background:#2d7cff; border-color:#2d7cff}
    main{flex:1; padding:var(--gap); box-sizing:border-box; display:flex; flex-direction:column}

    .grid-wrap{flex:1; display:grid; gap:var(--gap); align-content:start}

    .card{position:relative; background:var(--card); border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center}
    .card iframe{width:100%; height:100%; border:0; display:block}
    .placeholder{width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding:18px; box-sizing:border-box}
    .plus{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px dashed #666}
    .meta{font-size:13px;color:var(--muted); text-align:center}

    .overlay{position:absolute; top:8px; right:8px; display:flex; gap:6px}
    .icon-btn{background:#0008; border:0; padding:6px 8px; border-radius:8px; cursor:pointer; backdrop-filter:blur(4px); color:#fff;}

    .editor{position:fixed; left:50%; transform:translateX(-50%); bottom:18px; width:min(980px,calc(100% - 40px)); background:#0e0e0e; border:1px solid #222; padding:12px; border-radius:12px; box-shadow:0 8px 30px #0008; display:flex; gap:8px; align-items:center}
    .editor input{flex:1; padding:10px; border-radius:8px; border:1px solid #333; background:#111; color:#fff}
    .small{font-size:13px;color:var(--muted)}

    footer{padding:10px 12px; font-size:13px; color:var(--muted); background:linear-gradient(180deg,#080808,#050505)}

    @media (max-width:700px){ header h1{font-size:14px} .editor{bottom:8px; padding:8px} }
  </style>
</head>
<body>
  <header>
    <h1>YouTube Embed Splits</h1>
    <div class="controls">
      <div class="small">レイアウト:</div>
      <button id="btn2" class="toggle">2画面</button>
      <button id="btn4" class="toggle">4画面</button>
      <button id="clear" title="すべてクリア">クリア</button>
    </div>
  </header>

  <main>
    <div id="grid" class="grid-wrap" aria-live="polite"></div>
  </main>

  <div id="editor" class="editor" style="display:none;">
    <div class="small">Slot</div>
    <input id="editorInput" placeholder="YouTubeの共有URL（例: https://youtu.be/abc123 または https://www.youtube.com/watch?v=abc123）" />
    <button id="saveBtn" class="primary">保存</button>
    <button id="cancelBtn">キャンセル</button>
  </div>

  <footer>リンクは自動保存されます。画面は可能な限りフルに使われます。</footer>

  <script>
    const STORAGE_KEY = 'yt_grid_links_v1';
    const LAYOUT_KEY = 'yt_grid_layout_v1';

    let layout = parseInt(localStorage.getItem(LAYOUT_KEY)) || 4;
    let links = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    while(links.length < layout) links.push(null);

    const grid = document.getElementById('grid');
    const btn2 = document.getElementById('btn2');
    const btn4 = document.getElementById('btn4');
    const editor = document.getElementById('editor');
    const editorInput = document.getElementById('editorInput');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const clearBtn = document.getElementById('clear');

    let editingIndex = null;

    function parseYouTubeId(url){
      if(!url) return null;
      try{
        if(/^[a-zA-Z0-9_-]{11}$/.test(url)) return url;
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        if(u.hostname.includes('youtube.com')){
          if(u.searchParams.get('v')) return u.searchParams.get('v');
          const parts = u.pathname.split('/');
          const idx = parts.indexOf('embed');
          if(idx >=0 && parts[idx+1]) return parts[idx+1];
        }
      }catch(e){}
      return null;
    }

    function toEmbedUrl(link){
      const id = parseYouTubeId(link);
      return id ? `https://www.youtube.com/embed/${id}?rel=0&autoplay=0` : null;
    }

    function saveAll(){
      links = links.slice(0, layout);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(links));
      localStorage.setItem(LAYOUT_KEY, String(layout));
    }

    function openEditor(index){
      editingIndex = index;
      editor.style.display = 'flex';
      editorInput.value = links[index] || '';
      editorInput.focus();
      editorInput.select();
    }

    function closeEditor(){
      editingIndex = null; editor.style.display = 'none'; editorInput.value = '';
    }

    function setLayout(n){
      layout = n;
      while(links.length < layout) links.push(null);
      renderGrid();
      saveAll();
    }

    function removeLink(index){
      links[index] = null;
      saveAll();
      renderGrid();
    }

    function renderGrid(){
      if(layout === 2){
        grid.style.gridTemplateColumns = '1fr 1fr';
        grid.style.gridAutoRows = '1fr';
      } else {
        grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
        grid.style.gridAutoRows = '1fr';
      }

      grid.innerHTML = '';
      for(let i=0;i<layout;i++){
        const card = document.createElement('div');
        card.className = 'card';
        card.style.minHeight = '220px';

        const link = links[i];
        const embed = toEmbedUrl(link);
        if(embed){
          const iframe = document.createElement('iframe');
          iframe.src = embed;
          iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen';
          card.appendChild(iframe);
        } else {
          const ph = document.createElement('div');
          ph.className = 'placeholder';
          const plus = document.createElement('div'); plus.className='plus'; plus.innerHTML = '<svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          ph.appendChild(plus);
          const meta = document.createElement('div'); meta.className='meta'; meta.textContent = 'ここにYouTubeリンクを追加';
          ph.appendChild(meta);
          card.appendChild(ph);

          card.addEventListener('click', ()=> openEditor(i));
        }

        const overlay = document.createElement('div'); overlay.className='overlay';
        const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.title='編集'; editBtn.innerHTML = '編集';
        editBtn.addEventListener('click',(e)=>{ e.stopPropagation(); openEditor(i); });
        overlay.appendChild(editBtn);

        const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='削除'; delBtn.innerHTML = '削除';
        delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(confirm('本当に削除しますか？')){ removeLink(i); } });
        overlay.appendChild(delBtn);

        card.appendChild(overlay);

        grid.appendChild(card);
      }

      btn2.classList.toggle('primary', layout===2);
      btn4.classList.toggle('primary', layout===4);
    }

    saveBtn.addEventListener('click', ()=>{
      const v = editorInput.value.trim();
      if(!v){ links[editingIndex] = null; saveAll(); renderGrid(); closeEditor(); return; }
      const id = parseYouTubeId(v);
      if(!id){ alert('YouTubeのURLまたは動画IDを正しく入れてください。'); return; }
      links[editingIndex] = v;
      saveAll(); renderGrid(); closeEditor();
    });

    editorInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') saveBtn.click();
      if(e.key === 'Escape') cancelBtn.click();
    });

    cancelBtn.addEventListener('click', ()=>{ closeEditor(); });

    btn2.addEventListener('click', ()=> setLayout(2));
    btn4.addEventListener('click', ()=> setLayout(4));

    clearBtn.addEventListener('click', ()=>{
      if(confirm('すべてのリンクを消去してよいですか？')){
        links = Array(layout).fill(null);
        saveAll(); renderGrid();
      }
    });

    grid.addEventListener('dblclick', (e)=>{
      const cards = Array.from(grid.children);
      const idx = cards.findIndex(c => c.contains(e.target));
      if(idx >=0) openEditor(idx);
    });

    renderGrid();

    function adjustCardHeights(){
      const vh = window.innerHeight - document.querySelector('header').offsetHeight - document.querySelector('footer').offsetHeight - 48;
      const rows = Math.ceil(layout / 2);
      const h = Math.max(180, Math.floor((vh - (rows-1)*12) / rows));
      document.querySelectorAll('.card').forEach(c=> c.style.minHeight = h + 'px');
    }
    window.addEventListener('resize', adjustCardHeights);
    adjustCardHeights();
  </script>
</body>
</html>

