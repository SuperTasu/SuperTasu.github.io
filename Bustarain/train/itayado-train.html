<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>電光掲示板 - 板宿・新長田</title>
  <style>
    :root {
      --main-green: #006940; /* 神戸市営地下鉄風グリーン */
      --sub-blue: #005c97;   /* 新長田用ブルー */
      --bg-color: #f4f4f4;
      --board-bg: #ffffff;
      --text-dark: #333;
      --accent-red: #d32f2f;
    }

    * { box-sizing: border-box; }

    body { 
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif; 
      background-color: var(--bg-color); 
      color: var(--text-dark); 
      margin: 0; 
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ヘッダーエリア */
    .header { 
      background-color: var(--main-green);
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      flex-shrink: 0;
      z-index: 10;
    }

    .station-name { 
      font-size: 1.5rem; 
      font-weight: bold; 
      margin: 0;
      letter-spacing: 0.05em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .clock-container {
      text-align: right;
      line-height: 1.2;
    }

    .clock { font-size: 1.4rem; font-weight: bold; font-family: monospace; }
    
    .status-badge {
      font-size: 0.8rem;
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
    }
    .status-badge.simulation { background: #ff9800; color: #000; font-weight: bold; }

    .settings-btn {
      background: none;
      border: 1px solid rgba(255,255,255,0.5);
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    .settings-btn:hover { background: rgba(255,255,255,0.2); }

    /* メインコンテンツ（グリッドレイアウト） */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr; /* PCは2列 */
      gap: 15px;
      padding: 15px;
      flex: 1;
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
      overflow-y: auto;
    }

    /* ボード共通スタイル */
    .board-card {
      background: var(--board-bg);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border-top: 5px solid var(--main-green);
    }

    .board-header {
      padding: 10px 15px;
      background: #eef7f2;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .line-symbol {
      background: var(--main-green);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .line-title {
      font-weight: bold;
      font-size: 1.1rem;
      color: var(--main-green);
      flex: 1;
    }

    .board-content {
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* 発車行のスタイル */
    .departure-row {
      padding: 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-height: 80px; /* 高さを確保 */
      justify-content: center;
    }

    .departure-row:last-child { border-bottom: none; }

    .row-label {
      font-size: 0.85rem;
      color: #666;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .time-display {
      font-size: 1.6rem;
      font-weight: bold;
      color: #333;
      display: flex;
      align-items: baseline;
      gap: 10px;
      flex-wrap: wrap;
    }

    .countdown {
      font-size: 1rem;
      color: var(--main-green);
      font-weight: normal;
    }

    /* 定刻過ぎアラート */
    .alert-text {
      color: var(--accent-red);
      font-weight: bold;
      animation: flash 2s infinite;
    }
    @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* 次の電車リスト */
    .next-list {
      background: #f9f9f9;
      padding: 10px 15px;
      border-top: 1px solid #eee;
    }
    .next-label { font-size: 0.8rem; color: #777; margin-bottom: 5px; }
    .next-items {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 5px;
    }
    .next-time-pill {
      background: white;
      border: 1px solid #ddd;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.95rem;
      font-weight: bold;
      color: #555;
      white-space: nowrap;
    }

    /* 新長田セクション（北行の中に配置） */
    .shinnagata-section {
      border-top: 4px solid var(--sub-blue);
      margin-top: auto; /* 下部に寄せる */
    }
    .shinnagata-section .board-header { background: #eef4f9; }
    .shinnagata-section .line-symbol { background: var(--sub-blue); }
    .shinnagata-section .line-title { color: var(--sub-blue); }
    .shinnagata-section .countdown { color: var(--sub-blue); }

    /* モーダル */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(3px);
    }
    .modal-content {
      background-color: #fff;
      margin: 15vh auto;
      padding: 25px;
      width: 90%;
      max-width: 450px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      position: relative;
    }
    .modal-header { margin-bottom: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .input-group { margin-bottom: 20px; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
    .input-group input, .input-group select { width: 100%; padding: 10px; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; }
    .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: opacity 0.2s; }
    .btn-primary { background: var(--main-green); color: white; }
    .btn-secondary { background: #ccc; color: #333; }
    .btn:hover { opacity: 0.9; }

    /* スマホ対応（1列表示） */
    @media (max-width: 768px) {
      .header { padding: 10px 15px; }
      .station-name { font-size: 1.2rem; }
      .clock { font-size: 1.1rem; }
      
      .main-grid {
        grid-template-columns: 1fr; /* 1列 */
        padding: 10px;
        gap: 15px;
      }
      
      .time-display { font-size: 1.4rem; }
      .countdown { font-size: 0.9rem; }
    }
  </style>
</head>
<body>

  <!-- ヘッダー -->
  <header class="header">
    <div class="station-name">板宿・新長田</div>
    <div class="header-right">
      <div class="clock-container">
        <div class="clock" id="clock">--:--:--</div>
        <div class="status-badge" id="dayIndicator">--</div>
      </div>
      <button class="settings-btn" id="open-settings" title="詳細設定">&#9881;</button>
    </div>
  </header>

  <!-- メイングリッド -->
  <main class="main-grid">
    
    <!-- 左カラム：北行＋新長田 -->
    <div class="board-card" id="northbound-card">
      <!-- 板宿 北行 -->
      <div class="board-header">
        <span class="line-symbol">S10 板宿</span>
        <span class="line-title">① 三宮・谷上方面</span>
      </div>
      <div class="board-content">
        <div class="departure-row" id="north-1"></div>
        <div class="departure-row" id="north-2"></div>
        <div class="next-list">
          <div class="next-label">以降のダイヤ</div>
          <div class="next-items" id="north-nexts"></div>
        </div>
      </div>

      <!-- 新長田 北行 (セクションとして内包) -->
      <div class="shinnagata-section">
        <div class="board-header">
          <span class="line-symbol">K10 新長田</span>
          <span class="line-title">海岸線 三宮・花時計前方面</span>
        </div>
        <div class="board-content">
          <div class="departure-row" id="shinnagata-1"></div>
          <div class="next-list">
            <div class="next-items" id="shinnagata-nexts"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右カラム：南行 -->
    <div class="board-card" id="southbound-card">
      <div class="board-header">
        <span class="line-symbol">S10 板宿</span>
        <span class="line-title">② 名谷・西神中央方面</span>
      </div>
      <div class="board-content">
        <div class="departure-row" id="south-1"></div>
        <div class="departure-row" id="south-2"></div>
        <div class="next-list">
          <div class="next-label">以降のダイヤ</div>
          <div class="next-items" id="south-nexts"></div>
        </div>
      </div>
    </div>

  </main>

  <!-- 設定モーダル -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">詳細設定</div>
      
      <div class="input-group">
        <label>日時設定 (タイムトラベル)</label>
        <input type="datetime-local" id="setting-datetime" step="1">
      </div>
      
      <div class="input-group">
        <label>ダイヤ種別</label>
        <select id="setting-schedule-type">
          <option value="auto">自動判定 (日付に従う)</option>
          <option value="weekday">平日ダイヤ固定</option>
          <option value="holiday">土休日ダイヤ固定</option>
        </select>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" id="reset-settings">現在時刻に戻す</button>
        <button class="btn btn-primary" id="apply-settings">適用する</button>
      </div>
    </div>
  </div>

  <script>
    // --- 時刻表データ (変更なし) ---
    const northTimesWeekdays={5:[28,41,48,58],6:[6,15,24,30,40,46,52,59],7:[4,9,15,19,23,27,32,36,40,44,48,51,55,58],8:[2,5,9,13,17,21,25,30,34,39,44,49,53,59],9:[4,9,16,20,24,29,33,38,46,54],10:[2,10,17,25,32,40,47,55],11:[2,10,17,25,32,40,47,55],12:[2,10,17,25,32,40,47,55],13:[2,10,17,25,32,40,47,55],14:[2,10,17,25,32,40,47,55],15:[2,10,17,25,32,40,47,54,57],16:[3,9,16,24,31,37,43,49,55],17:[1,9,15,20,25,31,36,42,48,54],18:[0,5,11,17,22,27,34,40,46,51,56],19:[2,8,14,21,26,33,38,44,50,56],20:[1,8,13,18,24,30,37,44,49,55],21:[1,7,13,19,24,30,35,41,48,55],22:[1,8,15,23,33,41,49,56],23:[7,17,33,42,50],0:[10,21]};
    const northTimesHolidays={5:[28,41,48],6:[1,13,23,32,41,48,55],7:[4,10,16,22,27,33,39,45,52,59],8:[4,10,14,20,25,31,37,42,47,53,59],9:[5,10,16,23,31,38,47,54],10:[2,10,17,25,32,40,47,55],11:[2,10,17,25,32,40,47,55],12:[2,10,17,25,32,40,47,55],13:[2,10,17,25,32,40,47,55],14:[2,10,17,25,32,40,47,55],15:[2,10,17,25,32,40,47,55],16:[1,7,12,19,25,32,40,48,55],17:[3,10,18,25,32,39,46,53],18:[0,7,14,20,27,34,40,46,54],19:[1,9,17,24,31,38,46,54],20:[1,8,15,23,30,37,45,52],21:[0,8,15,23,31,39,47,54],22:[1,8,12,20,27,35,42,50,57],23:[4,17,32,44,50],0:[]};
    const southTimesWeekdays={5:[42,55],6:[5,15,26,35,42,52],7:[0,7,14,19,23,28,32,35,39,44,48,53,58],8:[3,7,12,16,20,24,27,31,34,38,41,45,49,53,57],9:[2,6,10,15,20,27,33,36,41,46,52],10:[0,8,14,21,28,36,43,51,58],11:[6,13,21,28,36,43,51,58],12:[6,13,21,28,36,43,51,58],13:[6,13,21,28,36,43,51,58],14:[6,13,21,28,36,43,51,58],15:[6,13,21,29,36,43,51,58],16:[8,15,22,28,34,40,45,51,57],17:[3,8,14,20,25,31,36,41,46,53],18:[0,6,11,17,23,28,35,41,47,52,58],19:[4,9,15,21,27,32,37,43,49,55],20:[2,8,14,21,27,33,38,44,50,55],21:[1,8,15,23,28,36,42,47,53],22:[1,10,21,27,35,43,51,59],23:[7,12,17,25,31,37,50],0:[2,19,33,48]};
    const southTimesHolidays={5:[42,55],6:[9,22,30,40,52,59],7:[5,11,23,29,35,39,45,50,57],8:[2,7,13,20,24,30,36,40,46,51,57],9:[2,10,16,22,28,35,40,44,52,59],10:[6,14,21,28,36,43,51,58],11:[6,13,21,28,36,43,51,58],12:[6,13,21,28,36,43,51,58],13:[6,13,21,28,36,43,51,58],14:[6,13,21,28,36,43,51,58],15:[6,13,21,27,36,44,51,58],16:[6,13,21,29,36,44,51,58],17:[4,11,18,24,31,39,46,54],18:[0,8,14,22,29,36,44,51,58],19:[6,13,22,28,35,41,48,54],20:[1,9,16,24,32,40,48,57],21:[6,13,21,28,36,44,51,59],22:[7,15,22,29,36,42,49,56],23:[5,15,21,27,38,50],0:[1]};
    const shinnagataTimes={5:[35,51],6:[8,20,31,40,50,57],7:[5,12,20,26,32,38,44,50,56],8:[2,8,14,20,26,32,38,44,52,57],9:[0,4,10,20,30,40,50],10:[0,10,20,30,40,50],11:[0,10,20,30,40,50],12:[0,10,20,30,40,50],13:[0,10,20,30,40,50],14:[0,10,20,30,40,50],15:[0,10,20,30,40,50],16:[0,10,20,30,40,50],17:[0,7,15,23,30,37,45,52],18:[0,7,15,22,30,37,45,52],19:[0,10,20,23,30,40,50],20:[0,10,20,30,40,50],21:[0,10,20,30,41,53],22:[5,17,29,45,50,59],23:[15,30,45,56],0:[]};
    const shinnagataTimesHolidays={5:[35,51],6:[9,20,35,45,55],7:[5,15,25,35,45,55],8:[2,10,17,25,32,40,45,50],9:[0,5,10,20,30,40,50],10:[0,10,20,30,40,50],11:[0,10,20,30,40,50],12:[0,10,20,30,40,50],13:[0,10,20,30,40,50],14:[0,10,20,30,40,50],15:[0,10,20,30,40,50],16:[0,10,20,30,40,50],17:[0,10,20,30,40,50],18:[0,10,20,30,40,50],19:[0,10,20,30,40,50],20:[0,10,20,30,40,50],21:[0,10,20,30,41,53],22:[5,17,29,45,50,59],23:[15,30,45,56],0:[]};

    // --- ロジック ---
    let timeOffset = 0;
    let isSimulated = false;
    let scheduleOverride = 'auto';

    function getCurrentTime() {
      const now = new Date();
      return isSimulated ? new Date(now.getTime() + timeOffset) : now;
    }

    // 祝日判定 (2024-2025対応)
    function isHoliday(date){const t=date.getFullYear(),e=date.getMonth()+1,n=date.getDate(),o=date.getDay();if(0===o||6===o)return!0;const a=[[1,1],[2,11],[2,23],[4,29],[5,3],[5,4],[5,5],[8,11],[11,3],[11,23]];for(let[t,o]of a)if(e===t&&n===o)return!0;if(2024===t){const t=[[1,8],[3,20],[7,15],[9,16],[9,22],[10,14]];for(let[o,a]of t)if(e===o&&n===a)return!0}else if(2025===t){const t=[[1,13],[3,20],[7,21],[9,15],[9,23],[10,13]];for(let[o,a]of t)if(e===o&&n===a)return!0}return!1}

    function formatTime(t){ return `${t.hour.toString().padStart(2,"0")}:${t.min.toString().padStart(2,"0")}`; }

    // スケジュールをフラット化してソート (0-3時を24-27時として扱う)
    function flattenSchedule(schedule) {
      let list = [];
      for (let h = 0; h <= 23; h++) {
        let sortHour = h === 0 || h === 1 || h === 2 || h === 3 ? h + 24 : h; 
        // データがそもそも0時の場合、深夜便として扱う
        if (h === 0 && (!schedule[0] || schedule[0].length === 0)) sortHour = 24;

        const mins = schedule[h] || [];
        mins.forEach(m => {
          list.push({ hour: h, sortHour: sortHour, min: m, absMin: sortHour * 60 + m });
        });
      }
      return list.sort((a, b) => a.absMin - b.absMin);
    }

    // 表示リスト取得 (定刻過ぎ3分ルール適用)
    function getDisplayList(scheduleObj) {
      const now = getCurrentTime();
      let currentH = now.getHours();
      if (currentH < 4) currentH += 24; // 現在時刻も深夜対応
      const currentAbs = currentH * 60 + now.getMinutes();

      const flatList = flattenSchedule(scheduleObj);
      
      // フィルタ: 3分前(-3) ～ 未来
      return flatList.filter(t => (t.absMin - currentAbs) >= -3).slice(0, 7);
    }

    // ステータス文字列生成
    function getStatusHTML(train, now) {
      let currentH = now.getHours();
      if (currentH < 4) currentH += 24;
      const currentAbs = currentH * 60 + now.getMinutes();
      const diffMin = train.absMin - currentAbs;

      // HTML返却
      if (diffMin < 0) {
        return `<span class="time-display">${formatTime(train)} <span class="alert-text">定刻を過ぎました</span></span>`;
      } else {
        // カウントダウン計算
        const trainDate = new Date(now);
        let targetH = train.hour;
        if (now.getHours() >= 23 && train.hour < 4) trainDate.setDate(trainDate.getDate() + 1);
        trainDate.setHours(targetH);
        trainDate.setMinutes(train.min);
        trainDate.setSeconds(0);

        let diffMs = trainDate - now;
        if (diffMs < 0) diffMs = 0;
        
        const secTotal = Math.floor(diffMs / 1000);
        const h = Math.floor(secTotal / 3600);
        const m = Math.floor((secTotal % 3600) / 60);
        const s = secTotal % 60;
        
        const timeText = h > 0 ? `${h}時間${m}分${s}秒` : `${m}分${s}秒`;
        
        // 分かりやすく "あと XX分XX秒" と表示
        return `<span class="time-display">${formatTime(train)} <span class="countdown">あと ${timeText}</span></span>`;
      }
    }

    // DOM更新関数
    function updateSection(scheduleObj, prefix) {
      const now = getCurrentTime();
      const trains = getDisplayList(scheduleObj);
      
      const elRow1 = document.getElementById(`${prefix}-1`);
      const elRow2 = document.getElementById(`${prefix}-2`); // 新長田には無い場合がある
      const elNexts = document.getElementById(`${prefix}-nexts`);

      // リセット
      if (elRow1) elRow1.innerHTML = `<span class="row-label">先発</span><span class="time-display" style="color:#aaa">--:--</span>`;
      if (elRow2) elRow2.innerHTML = `<span class="row-label">次発</span><span class="time-display" style="color:#aaa">--:--</span>`;
      elNexts.innerHTML = "";

      if (trains.length === 0) {
        if(elRow1) elRow1.innerHTML = `<span class="row-label">先発</span><span class="time-display" style="color:#888">運行終了</span>`;
        return;
      }

      // 先発
      if (trains[0]) {
        elRow1.innerHTML = `<span class="row-label">先発</span>${getStatusHTML(trains[0], now)}`;
      }
      
      // 次発
      if (elRow2 && trains[1]) {
        elRow2.innerHTML = `<span class="row-label">次発</span>${getStatusHTML(trains[1], now)}`;
      }

      // 以降のダイヤ
      // 新長田は2番目からリストへ、他は3番目からリストへ
      const startIdx = elRow2 ? 2 : 1; 
      trains.slice(startIdx, 7).forEach(t => {
        const span = document.createElement("span");
        span.className = "next-time-pill";
        span.textContent = formatTime(t);
        elNexts.appendChild(span);
      });
    }

    function updateAll() {
      const now = getCurrentTime();
      
      // 時計更新
      const h = now.getHours().toString().padStart(2,"0");
      const m = now.getMinutes().toString().padStart(2,"0");
      const s = now.getSeconds().toString().padStart(2,"0");
      document.getElementById("clock").textContent = `${h}:${m}:${s}`;

      // 曜日判定
      let isHol = false;
      if (scheduleOverride === 'weekday') isHol = false;
      else if (scheduleOverride === 'holiday') isHol = true;
      else isHol = isHoliday(now);

      // インジケーター更新
      const ind = document.getElementById("dayIndicator");
      ind.textContent = isHol ? "土休日ダイヤ" : "平日ダイヤ";
      if (isSimulated) {
        ind.textContent += " (仮想)";
        ind.classList.add("simulation");
      } else {
        ind.classList.remove("simulation");
      }

      // ボード更新
      if (isHol) {
        updateSection(northTimesHolidays, "north");
        updateSection(shinnagataTimesHolidays, "shinnagata");
        updateSection(southTimesHolidays, "south");
      } else {
        updateSection(northTimesWeekdays, "north");
        updateSection(shinnagataTimes, "shinnagata");
        updateSection(southTimesWeekdays, "south");
      }
    }

    // ループ開始
    updateAll();
    setInterval(updateAll, 1000);

    // --- 設定モーダル制御 ---
    const modal = document.getElementById("settings-modal");
    const openBtn = document.getElementById("open-settings");
    const applyBtn = document.getElementById("apply-settings");
    const resetBtn = document.getElementById("reset-settings");
    const dateInput = document.getElementById("setting-datetime");
    const typeInput = document.getElementById("setting-schedule-type");

    function toLocalISO(date) {
      const pad = n => (n<10?'0':'')+n;
      return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate())+'T'+pad(date.getHours())+':'+pad(date.getMinutes())+':'+pad(date.getSeconds());
    }

    openBtn.onclick = () => {
      modal.style.display = "block";
      dateInput.value = toLocalISO(getCurrentTime());
      typeInput.value = scheduleOverride;
    };

    applyBtn.onclick = () => {
      if(dateInput.value) {
        timeOffset = new Date(dateInput.value) - new Date();
        isSimulated = true;
      }
      scheduleOverride = typeInput.value;
      modal.style.display = "none";
      updateAll();
    };

    resetBtn.onclick = () => {
      timeOffset = 0;
      isSimulated = false;
      scheduleOverride = 'auto';
      modal.style.display = "none";
      updateAll();
    };

    window.onclick = (e) => {
      if (e.target == modal) modal.style.display = "none";
    };
  </script>
</body>
</html>
