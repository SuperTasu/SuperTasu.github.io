<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>回線速度測定</title>
<style>
body {
  background: #0f0f0f;
  color: #fff;
  font-family: system-ui, sans-serif;
  text-align: center;
  padding-top: 70px;
}

#current {
  font-size: 64px;
  font-weight: bold;
}

.unit {
  font-size: 20px;
  color: #aaa;
}

.info {
  margin-top: 20px;
  font-size: 22px;
}

button {
  margin-top: 40px;
  font-size: 20px;
  padding: 12px 40px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
button:disabled {
  opacity: 0.5;
}
</style>
</head>
<body>

<div id="current">0.00</div>
<div class="unit">Mbps（現在）</div>

<div class="info">Peak：<span id="peak">--</span> Mbps</div>
<div class="info">Average：<span id="average">--</span> Mbps</div>
<div class="info" id="status">待機中</div>

<button id="btn" onclick="startTest()">測定開始</button>

<script>
async function startTest() {
  const currentEl = document.getElementById("current");
  const peakEl = document.getElementById("peak");
  const avgEl = document.getElementById("average");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btn");

  btn.disabled = true;
  statusEl.textContent = "測定中…";

  const TEST_TIME = 10; // 秒（fast.com寄り）
  const url =
    "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg?cache=" +
    Math.random();

  let startTime = performance.now();
  let loadedBytes = 0;
  let peakSpeed = 0;

  const response = await fetch(url);
  const reader = response.body.getReader();

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    loadedBytes += value.length;
    const now = performance.now();
    const elapsed = (now - startTime) / 1000;

    if (elapsed > TEST_TIME) break;

    const currentSpeed =
      (loadedBytes * 8) / elapsed / 1024 / 1024;

    peakSpeed = Math.max(peakSpeed, currentSpeed);

    currentEl.textContent = currentSpeed.toFixed(2);
  }

  const totalTime = (performance.now() - startTime) / 1000;
  const avgSpeed =
    (loadedBytes * 8) / totalTime / 1024 / 1024;

  peakEl.textContent = peakSpeed.toFixed(2);
  avgEl.textContent = avgSpeed.toFixed(2);

  statusEl.textContent = "測定完了";
  btn.disabled = false;
}
</script>

</body>
</html>
