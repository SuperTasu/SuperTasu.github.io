<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>回線速度モニター</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
* { -webkit-user-select: none; user-select: none; }

body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: system-ui, -apple-system;
  text-align: center;
}

#speed {
  font-size: 64px;
  margin-top: env(safe-area-inset-top);
}

#grid {
  display: flex;
  justify-content: center;
  gap: 36px;
  margin-top: 10px;
  font-size: 20px;
}

.label {
  font-size: 14px;
  color: #aaa;
}

canvas {
  width: 100vw;
  height: 260px;
}
</style>
</head>
<body>

<div id="speed">
  ↓ <span id="down">0.00</span> Mbps
</div>

<div id="grid">
  <div><div class="label">Peak</div><div id="peak">--</div></div>
  <div><div class="label">Avg</div><div id="avg">--</div></div>
  <div><div class="label">Ping</div><div><span id="ping">--</span> ms</div></div>
  <div><div class="label">FPS</div><div id="fps">--</div></div>
</div>

<canvas id="graph"></canvas>

<script>
/* ========= 設定 ========= */
const DL_URL =
 "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg";
const PING_URL = "https://www.google.com/generate_204";

const CONNECTIONS = 5;
const SAMPLE_INTERVAL = 300;
const DISPLAY_INTERVAL = 1000;
const AVG_WINDOW = 10000;
const GRAPH_WINDOW = 60000;
/* ======================== */

const downEl = document.getElementById("down");
const peakEl = document.getElementById("peak");
const avgEl = document.getElementById("avg");
const pingEl = document.getElementById("ping");
const fpsEl = document.getElementById("fps");

const canvas = document.getElementById("graph");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  const dpr = devicePixelRatio || 1;
  canvas.width = innerWidth * dpr;
  canvas.height = 260 * dpr;
  ctx.scale(dpr, dpr);
}
resizeCanvas();
addEventListener("resize", resizeCanvas);

/* ===== 速度測定 ===== */
let startTime = performance.now();
let loadedBytes = 0;
let peakSpeed = 0;
let samples = [];

async function downloadLoop() {
  while (true) {
    const res = await fetch(DL_URL + "?r=" + Math.random());
    const reader = res.body.getReader();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      loadedBytes += value.length;
    }
  }
}
for (let i = 0; i < CONNECTIONS; i++) downloadLoop();

/* ===== サンプリング ===== */
setInterval(() => {
  const now = performance.now();
  const elapsed = (now - startTime) / 1000;
  const speed = (loadedBytes * 8) / elapsed / 1024 / 1024;

  peakSpeed = Math.max(peakSpeed, speed);
  samples.push({ time: now, speed });
  samples = samples.filter(s => now - s.time <= GRAPH_WINDOW);

  drawGraph();
}, SAMPLE_INTERVAL);

/* ===== 表示（毎秒） ===== */
setInterval(() => {
  const now = performance.now();
  const elapsed = (now - startTime) / 1000;

  const current =
    (loadedBytes * 8) / elapsed / 1024 / 1024;

  const recent = samples.filter(s => now - s.time <= AVG_WINDOW);
  const avg =
    recent.reduce((a, b) => a + b.speed, 0) / recent.length || 0;

  downEl.textContent = current.toFixed(2);
  peakEl.textContent = peakSpeed.toFixed(2);
  avgEl.textContent = avg.toFixed(2);
}, DISPLAY_INTERVAL);

/* ===== Ping ===== */
async function pingTest() {
  let r = [];
  for (let i = 0; i < 5; i++) {
    const t = performance.now();
    try {
      await fetch(PING_URL + "?p=" + Math.random(), {
        method: "HEAD",
        cache: "no-store",
        mode: "no-cors"
      });
      r.push(performance.now() - t);
    } catch {}
  }
  r.sort((a,b)=>a-b);
  pingEl.textContent = r[Math.floor(r.length/2)].toFixed(0);
}
pingTest();
setInterval(pingTest, DISPLAY_INTERVAL);

/* ===== FPS ===== */
let frames = 0;
let last = performance.now();
function fpsLoop() {
  frames++;
  const now = performance.now();
  if (now - last >= 1000) {
    fpsEl.textContent = frames;
    frames = 0;
    last = now;
  }
  requestAnimationFrame(fpsLoop);
}
fpsLoop();

/* ===== グラフ ===== */
function drawGraph() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (samples.length < 2) return;

  const max = Math.max(...samples.map(s => s.speed)) || 1;
  ctx.beginPath();
  ctx.strokeStyle = "#00ffd5";
  ctx.lineWidth = 2;

  samples.forEach((s, i) => {
    const x = (i / (samples.length - 1)) * innerWidth;
    const y = 260 - (s.speed / max) * 260;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ===== Service Worker ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
