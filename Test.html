<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>回線速度測定</title>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  padding-top: 80px;
}

#speed {
  font-size: 64px;
  font-weight: bold;
}

#unit {
  font-size: 24px;
  color: #aaa;
}

#status {
  margin-top: 15px;
  font-size: 18px;
  color: #ccc;
}

button {
  margin-top: 40px;
  font-size: 20px;
  padding: 12px 40px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

button:disabled {
  opacity: 0.5;
}
</style>
</head>
<body>

<div id="speed">0.00</div>
<div id="unit">Mbps</div>
<div id="status">待機中</div>

<button id="btn" onclick="startTest()">測定開始</button>

<script>
async function startTest() {
  const speedEl = document.getElementById("speed");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btn");

  btn.disabled = true;
  statusEl.textContent = "測定中…";

  const url =
    "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg?cache=" +
    Math.random();

  const startTime = performance.now();
  let lastTime = startTime;
  let loadedBytes = 0;

  const response = await fetch(url);
  const reader = response.body.getReader();

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    loadedBytes += value.length;

    const now = performance.now();
    const elapsed = (now - startTime) / 1000;

    const speedMbps =
      (loadedBytes * 8) / elapsed / 1024 / 1024;

    speedEl.textContent = speedMbps.toFixed(2);
    lastTime = now;
  }

  statusEl.textContent = "測定完了";
  btn.disabled = false;
}
</script>

</body>
</html>
