<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Fast.com風 回線速度測定</title>
<style>
body {
  background: #0b0b0b;
  color: #fff;
  font-family: system-ui, sans-serif;
  text-align: center;
  padding-top: 60px;
}
#current {
  font-size: 64px;
  font-weight: bold;
}
.info {
  margin-top: 15px;
  font-size: 22px;
}
#status {
  margin-top: 20px;
  color: #aaa;
}
button {
  margin-top: 40px;
  font-size: 20px;
  padding: 12px 40px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
button:disabled { opacity: 0.5; }
.warn { color: #ff6b6b; }
</style>
</head>
<body>

<div id="current">0.00 Mbps</div>
<div class="info">Peak：<span id="peak">--</span> Mbps</div>
<div class="info">Average：<span id="avg">--</span> Mbps</div>
<div id="status">待機中</div>

<button id="btn" onclick="startTest()">測定開始</button>

<script>
async function startTest() {
  const currentEl = document.getElementById("current");
  const peakEl = document.getElementById("peak");
  const avgEl = document.getElementById("avg");
  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btn");

  btn.disabled = true;
  statusEl.textContent = "測定中…";

  const CONNECTIONS = 5;      // 同時接続数（fast.comはもっと多い）
  const TEST_TIME = 12;       // 秒
  const WARMUP = 2;           // ウォームアップ除外
  const URL =
    "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg";

  let startTime = performance.now();
  let loadedBytes = 0;
  let peak = 0;
  let samples = [];

  async function download() {
    const res = await fetch(URL + "?c=" + Math.random());
    const reader = res.body.getReader();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      loadedBytes += value.length;
    }
  }

  // 並列ダウンロード開始
  for (let i = 0; i < CONNECTIONS; i++) download();

  const timer = setInterval(() => {
    const now = performance.now();
    const elapsed = (now - startTime) / 1000;

    const speed =
      (loadedBytes * 8) / elapsed / 1024 / 1024;

    currentEl.textContent = speed.toFixed(2) + " Mbps";
    peak = Math.max(peak, speed);

    if (elapsed > WARMUP) {
      samples.push(speed);
    }

    if (elapsed >= TEST_TIME) {
      clearInterval(timer);

      const avg =
        samples.reduce((a, b) => a + b, 0) / samples.length;

      peakEl.textContent = peak.toFixed(2);
      avgEl.textContent = avg.toFixed(2);

      // 制限検出（ピークの60%以下に落ちたら警告）
      if (avg < peak * 0.6) {
        statusEl.innerHTML =
          "<span class='warn'>回線制限の可能性あり</span>";
      } else {
        statusEl.textContent = "測定完了";
      }

      btn.disabled = false;
    }
  }, 300);
}
</script>

</body>
</html>
