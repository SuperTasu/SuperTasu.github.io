<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>常時回線速度モニター</title>
<style>
body {
  margin: 0;
  background: #0b0b0b;
  color: #fff;
  font-family: system-ui, sans-serif;
  text-align: center;
}

#current {
  font-size: 64px;
  margin-top: 40px;
}

#stats {
  display: flex;
  justify-content: center;
  gap: 60px;
  margin-top: 10px;
  font-size: 22px;
}

.label {
  color: #aaa;
}

canvas {
  margin-top: 30px;
  background: #111;
  border-top: 1px solid #222;
}
</style>
</head>
<body>

<div id="current">0.00 Mbps</div>

<div id="stats">
  <div>
    <div class="label">Peak</div>
    <div id="peak">--</div>
  </div>
  <div>
    <div class="label">Average</div>
    <div id="avg">--</div>
  </div>
</div>

<canvas id="graph" width="800" height="250"></canvas>

<script>
const URL =
  "https://upload.wikimedia.org/wikipedia/commons/3/3f/Fronalpstock_big.jpg";

const CONNECTIONS = 5;
const SAMPLE_INTERVAL = 300; // ms
const AVG_WINDOW = 10000;    // 10秒
const GRAPH_WINDOW = 60000;  // 60秒

let startTime = performance.now();
let loadedBytes = 0;
let peakSpeed = 0;
let samples = [];

const currentEl = document.getElementById("current");
const peakEl = document.getElementById("peak");
const avgEl = document.getElementById("avg");

const canvas = document.getElementById("graph");
const ctx = canvas.getContext("2d");

async function downloadLoop() {
  while (true) {
    const res = await fetch(URL + "?r=" + Math.random());
    const reader = res.body.getReader();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      loadedBytes += value.length;
    }
  }
}

// 並列ダウンロード開始
for (let i = 0; i < CONNECTIONS; i++) {
  downloadLoop();
}

// サンプリング
setInterval(() => {
  const now = performance.now();
  const elapsed = (now - startTime) / 1000;

  const speed =
    (loadedBytes * 8) / elapsed / 1024 / 1024;

  peakSpeed = Math.max(peakSpeed, speed);

  samples.push({ time: now, speed });

  // 古いデータ削除
  samples = samples.filter(s => now - s.time <= GRAPH_WINDOW);

  // 平均（直近10秒）
  const recent = samples.filter(s => now - s.time <= AVG_WINDOW);
  const avg =
    recent.reduce((a, b) => a + b.speed, 0) / recent.length || 0;

  currentEl.textContent = speed.toFixed(2) + " Mbps";
  peakEl.textContent = peakSpeed.toFixed(2);
  avgEl.textContent = avg.toFixed(2);

  drawGraph();
}, SAMPLE_INTERVAL);

function drawGraph() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (samples.length < 2) return;

  const maxSpeed = Math.max(...samples.map(s => s.speed)) || 1;

  ctx.beginPath();
  ctx.strokeStyle = "#4fd1c5";
  ctx.lineWidth = 2;

  samples.forEach((s, i) => {
    const x =
      (i / (samples.length - 1)) * canvas.width;
    const y =
      canvas.height -
      (s.speed / maxSpeed) * canvas.height;

    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
}
</script>

</body>
</html>
