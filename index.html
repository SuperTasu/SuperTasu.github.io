<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Link First</title>
  <link rel="icon" href="./icon.png" type="image/png">
  <link rel="apple-touch-icon" href="./icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* --- CSS変数 --- */
    :root {
      --bg-color: #ffffff;
      --text-color-primary: #333333;
      --text-color-secondary: #666;
      --card-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      --card-border-color: rgba(0,0,0,0.1);
      --card-shadow: 0 4px 16px rgba(0,0,0,0.1);
      
      --tab-active-bg: #667eea;
      --tab-active-text: #ffffff;
      
      --input-bg: #e9ecef;
      --nav-bg: rgba(255, 255, 255, 0.98);

      /* ▼▼▼ スケッチ風カード用変数 ▼▼▼ */
      --capsule-border: #333;       /* 枠線の色 */
      --capsule-bg: #ffffff;        /* カード背景 */
      --capsule-hover-shadow: 0 4px 12px rgba(0,0,0,0.15);
      --btn-hover-bg: rgba(0,0,0,0.05);
    }

    body.dark-theme {
      --bg-color: #434343;
      --text-color-primary: #f5f5f5;
      --text-color-secondary: #aaa;
      --card-bg: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 100%);
      --card-border-color: rgba(255,255,255,0.1);
      --card-shadow: 0 4px 16px rgba(0,0,0,0.4);
      
      --tab-active-bg: #88aaff;
      --tab-active-text: #ffffff;

      --input-bg: #3a3a3a;
      --nav-bg: rgba(50, 50, 50, 0.98);

      /* Dark Mode用 */
      --capsule-border: #aaa;
      --capsule-bg: #333;
      --capsule-hover-shadow: 0 4px 12px rgba(0,0,0,0.5);
      --btn-hover-bg: rgba(255,255,255,0.1);
    }

    body {
      margin: 0;
      background-color: var(--bg-color);
      color: var(--text-color-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background-color 0.3s, color 0.3s;
      padding-bottom: 80px; 
      min-height: 100vh;
    }

    /* ★★★ 固定ヘッダー ★★★ */
    .fixed-top-wrapper {
      position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
      background-color: #000000; color: #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      padding: 5px 0;
      display: flex; flex-direction: column; align-items: center; gap: 2px;
    }

    .clock-area { 
        width: 100%; padding: 0 15px; box-sizing: border-box; 
        display: flex; align-items: center; height: 30px; 
    }
    .clock-main-row { display: flex; justify-content: flex-start; align-items: center; width: 100%; gap: 10px; }

    .site-logo { height: 26px; width: auto; margin-right: 5px; border-radius: 4px; background: #fff; }

    .datetime-row { display: flex; align-items: baseline; gap: 10px; }
    #date, #clock, #countdown { color: #ffffff; font-weight: bold; font-size: 14px; white-space: nowrap; }
    #countdown { color: #88aaff; }

    .header-controls { display: flex; align-items: center; gap: 10px; margin-left: 15px; }
    .control-icon { color: #aaaaaa; cursor: pointer; font-size: 14px; }
    .control-icon:hover { color: #ffffff; }
    .theme-switcher { display: flex; gap: 5px; }
    .theme-dot { width: 8px; height: 8px; border-radius: 50%; cursor: pointer; border: 1px solid #888; } 
    .theme-dot.light { background-color: #fff; }
    .theme-dot.dark { background-color: #444; }

    /* 速度テスト */
    .header-speed-test { position: absolute; right: 10px; top: 5px; display: flex; gap: 5px; z-index: 6000; pointer-events: none; }
    .header-speed-test iframe { pointer-events: auto; width: 150px; height: 50px; border: none; border-radius: 8px; background: #fff; }
    #speed-test-refresh-button { pointer-events: auto; color: #aaa; cursor: pointer; font-size: 16px; margin-top: 5px; background: rgba(0,0,0,0.5); border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }

    /* ★★★ 検索バー（常時表示） ★★★ */
    .search-wrapper { 
        display: flex !important; justify-content: center; width: 100%; 
        padding: 0 10px; box-sizing: border-box; position: relative; z-index: 5000; margin-top: 0;
    }
    .search-container { 
        display: flex; align-items: center; padding: 0 15px; 
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 20px; border: none; width: 80%; max-width: 500px; height: 36px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    #globalSearchInput { border: none; background: transparent; outline: none; width: 100%; font-size: 15px; color: #333; }
    #clearSearchBtn { cursor: pointer; color: #777; font-size: 0.9em; }
    
    .search-results-dropdown {
        position: absolute; top: 40px; left: 0; right: 0; margin: 0 auto;
        width: 85%; max-width: 550px; background-color: var(--card-bg);
        border-radius: 12px; box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        z-index: 5500; max-height: 60vh; overflow-y: auto; padding: 5px; 
        border: 1px solid var(--card-border-color);
    }
    .search-results-dropdown.hidden { display: none !important; }
    .search-result-item { display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 8px; background: rgba(255, 255, 255, 0.6); cursor: pointer; color: var(--text-color-primary); text-decoration: none; }
    body.dark-theme .search-result-item { background: rgba(0, 0, 0, 0.4); }
    .search-result-item:hover { background-color: var(--tab-active-bg); color: #fff; }

    /* メインエリア */
    .page-container { max-width: 1200px; margin: 0 auto; padding: 100px 20px 20px 20px; }
    #bustarain-container, #option-container, #fy-container, .main-grid { display: none; width: 100%; }

    /* ▼▼▼ カプセル型カードデザイン (スケッチ再現) ▼▼▼ */
    /* グリッドレイアウト */
    .capsule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 15px;
        padding: 10px;
        justify-content: center;
    }

    /* カード本体 */
    .capsule-card {
        display: flex;
        height: 80px;
        background-color: var(--capsule-bg);
        border: 1px solid var(--capsule-border);
        border-radius: 30px; /* 角丸（カプセル形状） */
        overflow: hidden;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .capsule-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--capsule-hover-shadow);
    }

    /* 左側：アイコンエリア */
    .capsule-left {
        width: 70px;
        border-right: 1px solid var(--capsule-border); /* 縦線 */
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
    }
    .capsule-icon {
        width: 40px;
        height: 40px;
        object-fit: contain;
        border-radius: 8px;
    }

    /* 右側：情報エリア */
    .capsule-right {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* 右上：名前エリア */
    .capsule-name-area {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center; /* 名前を中央揃え */
        border-bottom: 1px solid var(--capsule-border); /* 名前下の線 */
        padding: 0 10px;
        position: relative;
    }
    .capsule-name {
        font-size: 14px;
        font-weight: bold;
        color: var(--text-color-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-family: 'Segoe UI', sans-serif;
    }
    /* FY用のお気に入り星アイコン */
    .capsule-fav-star {
        position: absolute;
        top: 5px;
        right: 10px;
        font-size: 10px;
        color: #ffc107;
    }

    /* 右下：ボタンエリア */
    .capsule-btn-area {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center; /* ボタンを中央寄せ */
        gap: 15px; /* ボタン間の隙間 */
        padding: 5px;
    }

    /* 四角いボタン */
    .capsule-btn {
        width: 24px;
        height: 24px;
        border: 1px solid var(--capsule-border);
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        color: var(--text-color-secondary);
        font-size: 12px;
        border-radius: 2px; /* わずかな角丸（手書き感用） */
    }
    .capsule-btn:hover {
        background-color: var(--btn-hover-bg);
        color: var(--text-color-primary);
    }

    /* ▲▲▲ デザイン終了 ▲▲▲ */

    /* FY専用時計 */
    #fy-clock-display {
        text-align: center;
        margin: 0 auto 15px auto;
        padding: 5px 15px;
        background: var(--card-bg);
        border: 1px solid var(--card-border-color);
        border-radius: 15px;
        display: inline-block;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
    }
    #fy-clock-wrapper { display: flex; flex-direction: column; align-items: center; }
    #fy-date { font-size: 13px; color: var(--text-color-secondary); font-weight: bold; }
    #fy-time { font-size: 20px; font-weight: bold; color: var(--text-color-primary); letter-spacing: 1px; line-height: 1.2; }

    /* その他UI要素 */
    .section-title { font-size: 18px; color: var(--text-color-secondary); margin: 20px 0 10px; border-bottom: 2px solid var(--card-border-color); padding-bottom: 5px; }
    .fy-header-row { text-align: center; margin-bottom: 10px; position: relative; }

    /* 交通情報アコーディオン */
    .sub-tab-menu { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .sub-tab-btn { background: var(--input-bg); color: var(--text-color-secondary); border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
    .sub-tab-btn.active { background: #667eea; color: #fff; }
    .accordion-item { border: 1px solid var(--card-border-color); border-radius: 12px; margin-bottom: 10px; background: var(--card-bg); overflow: hidden; }
    .accordion-header { padding: 15px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
    .accordion-item.active .accordion-content { max-height: 800px; }
    .accordion-iframe { width: 100%; height: 500px; border: none; }
    .hidden { display: none !important; }

    /* 下部ナビ */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background-color: var(--nav-bg);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--card-border-color);
        display: flex; justify-content: space-around;
        padding: 5px 0 calc(5px + env(safe-area-inset-bottom));
        z-index: 2000;
    }
    .tab-item { 
        padding: 5px; color: var(--text-color-secondary); font-size: 10px; 
        cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; flex: 1;
    }
    .tab-item i { font-size: 20px; }
    .tab-item.active { color: var(--tab-active-text); }
    .tab-item.active i { color: #667eea; } /* 下部ナビのアクティブ色はアイコン色で表現 */
    body.dark-theme .tab-item.active i { color: #88aaff; }

    /* モーダル */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 7000; display: flex; align-items: center; justify-content: center; }
    .modal-box { background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }
    .modal-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .modal-btn { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

  <!-- 固定ヘッダー -->
  <div class="fixed-top-wrapper">
    <div class="clock-area">
        <div class="clock-main-row">
            <img src="./icon.png" alt="Logo" class="site-logo">
            <div class="datetime-row">
                <div id="date"></div>
                <div id="clock"></div>
                <div id="countdown"></div>
            </div>
             <div class="header-controls">
                <div class="theme-switcher">
                    <div class="theme-dot light" onclick="setTheme('light')"></div>
                    <div class="theme-dot dark" onclick="setTheme('dark')"></div>
                </div>
                <div class="control-icon" onclick="location.reload()"><i class="fas fa-sync-alt"></i></div>
            </div>
            <div class="header-speed-test">
                <iframe src="https://fast.com/ja/" scrolling="no"></iframe>
                <div id="speed-test-refresh-button" onclick="reloadSpeedTest()"><i class="fas fa-redo"></i></div>
            </div>
        </div>
    </div>
    <!-- 検索バー（常時表示） -->
    <div class="search-wrapper">
        <div class="search-container"> 
            <i class="fas fa-search"></i> 
            <input type="text" id="globalSearchInput" placeholder="検索..." autocomplete="off"> 
            <i class="fas fa-times hidden" id="clearSearchBtn"></i>
        </div>
        <div id="searchResults" class="search-results-dropdown hidden"></div>
    </div>
  </div>

  <div class="page-container">
      
      <!-- FY (Favorites) タブ -->
      <div id="fy-container">
          <!-- FY専用デジタル時計（上部真ん中） -->
          <div style="text-align:center;">
              <div id="fy-clock-display">
                  <div id="fy-clock-wrapper">
                      <div id="fy-date"></div>
                      <div id="fy-time"></div>
                  </div>
              </div>
          </div>

          <div class="fy-header-row">
              <h3 class="section-title" style="margin-top:0; border:none;"><i class="fas fa-star" style="color:#ffc107;"></i> Favorites</h3>
          </div>
          <!-- FY用グリッド（Appsと同じデザイン） -->
          <div id="fy-content-area" class="capsule-grid"></div>
      </div>

      <!-- Apps タブ -->
      <div class="main-grid" id="main-grid">
          <h3 class="section-title">All Apps</h3>
          <!-- Apps用グリッド（カプセルデザイン） -->
          <div id="gridContainer" class="capsule-grid"></div>
      </div>

      <!-- Traffic (Bustarain) タブ -->
      <div id="bustarain-container">
          <div class="sub-tab-menu">
              <button class="sub-tab-btn active" onclick="switchSubTab('train-content')"><i class="fas fa-train"></i> Train</button>
              <button class="sub-tab-btn" onclick="switchSubTab('bus-content')"><i class="fas fa-bus"></i> Bus</button>
          </div>
          <div id="train-content" class="sub-tab-content">
              <!-- 例: 和田岬 -->
              <div class="accordion-item">
                  <div class="accordion-header" onclick="toggleAccordion(this)">
                      <span>和田岬</span><i class="fas fa-chevron-down"></i>
                  </div>
                  <div class="accordion-content">
                      <iframe class="accordion-iframe" src="about:blank" data-src="train/wadmisaki-train.html"></iframe>
                  </div>
              </div>
              <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>板宿駅（山陽）</span><i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content">
                    <iframe class="accordion-iframe" src="about:blank" data-src="train/Itayado-sannyou.html"></iframe>
                </div>
            </div>
          </div>
          <div id="bus-content" class="sub-tab-content hidden">
              <div class="accordion-item">
                  <div class="accordion-header" onclick="toggleAccordion(this)">
                      <span>バスロケーション</span><i class="fas fa-chevron-down"></i>
                  </div>
                  <div class="accordion-content">
                      <iframe class="accordion-iframe" src="about:blank" data-src="bus/Buslocation.html"></iframe>
                  </div>
              </div>
              <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>板宿駅 バス</span><i class="fas fa-chevron-down"></i>
                </div>
                <div class="accordion-content">
                    <iframe class="accordion-iframe" src="about:blank" data-src="bus/Itayado-bus.html"></iframe>
                </div>
            </div>
          </div>
      </div>

      <!-- Option タブ -->
      <div id="option-container">
          <h3 class="section-title">Settings</h3>
          <div style="text-align:center; padding:20px; color:var(--text-color-secondary);">Option Page Content</div>
      </div>
  </div>

  <!-- 下部ナビ -->
  <nav class="bottom-nav">
      <div class="tab-item" id="tab-fy" onclick="activateTab('fy')"> 
          <i class="fas fa-star"></i><span>FY☆</span>
      </div>
      <div class="tab-item active" id="tab-all-apps" onclick="activateTab('all-apps')"> 
          <i class="fas fa-th-large"></i><span>Apps</span>
      </div>
      <div class="tab-item" id="tab-bustarain" onclick="activateTab('bustarain')"> 
          <i class="fas fa-bus"></i><span>Traffic</span>
      </div>
      <div class="tab-item" id="tab-option" onclick="activateTab('option')"> 
          <i class="fas fa-cog"></i><span>Option</span>
      </div>
  </nav>

  <!-- リンク確認モーダル -->
  <div id="link-confirm-overlay" class="modal-overlay hidden">
      <div class="modal-box">
          <div id="modal-title" style="font-weight:bold; margin-bottom:10px;">確認</div>
          <div id="modal-desc">どちらで開きますか？</div>
          <div class="modal-buttons">
              <button id="btn-same-tab" class="modal-btn" style="background:#667eea; color:#fff;">このページで開く</button>
              <button id="btn-new-tab" class="modal-btn" style="background:#28a745; color:#fff;">新しいタブで開く</button>
              <button id="btn-cancel-modal" class="modal-btn" style="background:var(--input-bg);">キャンセル</button>
          </div>
      </div>
  </div>

  <script>
      // --- データ定義 (デモ用) ---
      // ※実際には外部JSから読み込むか、ここで全リストを定義してください
      const appsData = [
          { name: 'Google', url: 'https://google.com', img: './icon.png' },
          { name: 'Yahoo!', url: 'https://yahoo.co.jp', img: './icon.png' },
          { name: 'YouTube', url: 'https://youtube.com', img: './icon.png' },
          { name: 'Weather', url: 'https://weather.yahoo.co.jp', img: './icon.png' },
          { name: 'News', url: 'https://news.yahoo.co.jp', img: './icon.png' },
          { name: 'Map', url: 'https://maps.google.com', img: './icon.png' },
          { name: 'Amazon', url: 'https://amazon.co.jp', img: './icon.png' },
          { name: 'Rakuten', url: 'https://rakuten.co.jp', img: './icon.png' }
      ];

      // FY (Favorites) 用のデータ（一部を抜粋）
      const fyData = [
          { name: 'Google', url: 'https://google.com', img: './icon.png' },
          { name: 'YouTube', url: 'https://youtube.com', img: './icon.png' },
          { name: 'Weather', url: 'https://weather.yahoo.co.jp', img: './icon.png' }
      ];

      document.addEventListener('DOMContentLoaded', () => {
          renderCapsuleCards(appsData, 'gridContainer');  // Apps描画
          renderCapsuleCards(fyData, 'fy-content-area');  // FY描画
          
          initClock(); // ヘッダー時計
          setInterval(updateFyClock, 1000); // FY時計
          updateFyClock();

          // 検索機能初期化
          initSearch();
          
          // タブ初期化
          activateTab('all-apps');
      });

      // --- ★★★ カプセル型カード描画関数 ★★★ ---
      function renderCapsuleCards(dataList, containerId) {
          const container = document.getElementById(containerId);
          if(!container) return;
          container.innerHTML = '';

          dataList.forEach(item => {
              // 1. カード全体
              const card = document.createElement('div');
              card.className = 'capsule-card';
              
              // カード自体のクリックイベント (通常遷移)
              card.onclick = (e) => {
                  window.location.href = item.url;
              };

              // 2. 左側：アイコンエリア
              const leftDiv = document.createElement('div');
              leftDiv.className = 'capsule-left';
              const img = document.createElement('img');
              img.src = item.img || './icon.png';
              img.className = 'capsule-icon';
              leftDiv.appendChild(img);

              // 3. 右側：情報エリア
              const rightDiv = document.createElement('div');
              rightDiv.className = 'capsule-right';

              // 3-1. 名前エリア (上部)
              const nameArea = document.createElement('div');
              nameArea.className = 'capsule-name-area';
              const nameSpan = document.createElement('span');
              nameSpan.className = 'capsule-name';
              nameSpan.textContent = item.name;
              nameArea.appendChild(nameSpan);
              
              // FYの場合は星マークをつける(オプション)
              if(containerId === 'fy-content-area') {
                  const star = document.createElement('i');
                  star.className = 'fas fa-star capsule-fav-star';
                  nameArea.appendChild(star);
              }

              // 3-2. ボタンエリア (下部) - 四角いボタン2つ
              const btnArea = document.createElement('div');
              btnArea.className = 'capsule-btn-area';

              // ボタン1: このページで開く
              const btnSelf = document.createElement('button');
              btnSelf.className = 'capsule-btn';
              btnSelf.innerHTML = '<i class="fas fa-arrow-right"></i>';
              btnSelf.title = 'このページで開く';
              btnSelf.onclick = (e) => {
                  e.stopPropagation(); // 親のクリックを無効化
                  window.location.href = item.url;
              };

              // ボタン2: バックグラウンド(新規タブ)で開く
              const btnBlank = document.createElement('button');
              btnBlank.className = 'capsule-btn';
              btnBlank.innerHTML = '<i class="fas fa-external-link-alt"></i>';
              btnBlank.title = '新しいタブで開く';
              btnBlank.onclick = (e) => {
                  e.stopPropagation();
                  window.open(item.url, '_blank');
              };

              btnArea.appendChild(btnSelf);
              btnArea.appendChild(btnBlank);

              // 組み立て
              rightDiv.appendChild(nameArea);
              rightDiv.appendChild(btnArea);

              card.appendChild(leftDiv);
              card.appendChild(rightDiv);

              container.appendChild(card);
          });
      }

      // --- FY専用時計 ---
      function updateFyClock() {
          const d = new Date();
          const dateEl = document.getElementById('fy-date');
          const timeEl = document.getElementById('fy-time');
          if(dateEl && timeEl) {
              // 日付
              dateEl.textContent = d.toLocaleDateString('ja-JP', { 
                  year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short' 
              });
              // 時間 (秒数まで)
              timeEl.textContent = d.toLocaleTimeString('ja-JP', { hour12: false });
          }
      }

      // --- タブ切り替え ---
      function activateTab(tabId) {
          // コンテンツ非表示
          ['fy-container', 'main-grid', 'bustarain-container', 'option-container'].forEach(id => {
              const el = document.getElementById(id);
              if(el) el.style.display = 'none';
          });
          // タブ状態リセット
          document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));

          // 対象表示
          let targetId = '';
          if(tabId === 'fy') targetId = 'fy-container';
          else if(tabId === 'all-apps') targetId = 'main-grid';
          else if(tabId === 'bustarain') targetId = 'bustarain-container';
          else if(tabId === 'option') targetId = 'option-container';

          const target = document.getElementById(targetId);
          if(target) target.style.display = 'block';
          
          const tabBtn = document.getElementById('tab-' + tabId);
          if(tabBtn) tabBtn.classList.add('active');

          // FY時計はFYタブが表示されたときのみCSSで自動的に見える(親要素内にあるため)
          // 追加ロジック不要
      }

      // --- その他機能 (Traffic, Clock, Theme, Search) ---
      function switchSubTab(id) {
          document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden'));
          document.getElementById(id).classList.remove('hidden');
          document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
          event.target.classList.add('active');
      }
      function toggleAccordion(header) {
          const item = header.parentElement;
          item.classList.toggle('active');
          // iframe遅延読み込み対応
          if(item.classList.contains('active')) {
              const frame = item.querySelector('iframe');
              if(frame && frame.getAttribute('data-src') && frame.src === 'about:blank') {
                  frame.src = frame.getAttribute('data-src');
              }
          }
      }
      function initClock() {
          const tick = () => {
              const now = new Date();
              document.getElementById('date').innerText = now.toLocaleDateString('ja-JP');
              document.getElementById('clock').innerText = now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
          };
          setInterval(tick, 1000); tick();
      }
      function setTheme(theme) {
          if(theme === 'dark') document.body.classList.add('dark-theme');
          else document.body.classList.remove('dark-theme');
      }
      function reloadSpeedTest() {
          const frame = document.querySelector('.header-speed-test iframe');
          frame.src = frame.src;
      }
      
      // 簡易検索機能
      function initSearch() {
          const input = document.getElementById('globalSearchInput');
          const results = document.getElementById('searchResults');
          const clear = document.getElementById('clearSearchBtn');
          const modal = document.getElementById('link-confirm-overlay');
          let targetUrl = '';

          input.addEventListener('input', (e) => {
              const val = e.target.value.toLowerCase();
              results.innerHTML = '';
              if(!val) { results.classList.add('hidden'); clear.classList.add('hidden'); return; }
              clear.classList.remove('hidden');

              // AppsとFYデータを結合して検索
              const allItems = [...appsData, ...fyData]; // 重複考慮せず簡易結合
              const hits = allItems.filter(i => i.name.toLowerCase().includes(val));

              if(hits.length > 0) {
                  results.classList.remove('hidden');
                  hits.forEach(hit => {
                      const div = document.createElement('div');
                      div.className = 'search-result-item';
                      div.innerHTML = `<img src="${hit.img}" style="width:20px; margin-right:10px;"><span>${hit.name}</span>`;
                      div.onclick = () => {
                          targetUrl = hit.url;
                          document.getElementById('modal-desc').innerText = `「${hit.name}」を開きます`;
                          modal.classList.remove('hidden');
                          results.classList.add('hidden');
                      };
                      results.appendChild(div);
                  });
              } else {
                  results.classList.remove('hidden');
                  results.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">なし</div>';
              }
          });

          document.getElementById('clearSearchBtn').onclick = () => {
              input.value = ''; input.dispatchEvent(new Event('input'));
          };
          
          // モーダル操作
          document.getElementById('btn-same-tab').onclick = () => { window.location.href = targetUrl; modal.classList.add('hidden'); };
          document.getElementById('btn-new-tab').onclick = () => { window.open(targetUrl, '_blank'); modal.classList.add('hidden'); };
          document.getElementById('btn-cancel-modal').onclick = () => { modal.classList.add('hidden'); };
      }
  </script>
</body>
</html>
